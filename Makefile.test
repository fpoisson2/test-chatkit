# Makefile pour tester les appels entrants
# Usage: make -f Makefile.test [target]
SHELL := /bin/bash

PJSIP_PY := /home/fpoisson/.pyenv/versions/pjsip311/bin/python


.PHONY: help install config test-minimal test-simple test-bridge clean

# Couleurs
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
RED := \033[0;31m
NC := \033[0m # No Color

help: ## Afficher cette aide
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(BLUE)  Test des Appels Entrants - Makefile$(NC)"
	@echo "$(BLUE)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}'
	@echo ""

install: ## Installer les d√©pendances
	@echo "$(BLUE)üì¶ Installation des d√©pendances...$(NC)"
	cd backend && pip install -r requirements.txt
	@echo "$(GREEN)‚úÖ D√©pendances install√©es$(NC)"

config: ## Cr√©er le fichier de configuration
	@if [ ! -f test_config.env ]; then \
		echo "$(BLUE)üìù Cr√©ation de test_config.env...$(NC)"; \
		cp test_config.example.env test_config.env; \
		echo "$(YELLOW)‚ö†Ô∏è  √âditez test_config.env avec vos param√®tres SIP$(NC)"; \
		echo "   nano test_config.env"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  test_config.env existe d√©j√†$(NC)"; \
	fi

test-minimal: ## Test minimal (appel simple)
	@echo "$(BLUE)üöÄ Lancement du test minimal...$(NC)"
	@./run_test.sh minimal

test-simple: ## Test simple avec PJSUA
	@echo "$(BLUE)üöÄ Lancement du test simple...$(NC)"
	@./run_test.sh simple

test-bridge: ## Test avec Voice Bridge (OpenAI)
	@echo "$(BLUE)üöÄ Lancement du test avec Voice Bridge...$(NC)"
	@./run_test.sh bridge

test-interactive: ## Test interactif (menu)
	@./test_example.sh

clean: ## Nettoyer les fichiers temporaires
	@echo "$(BLUE)üßπ Nettoyage...$(NC)"
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	@echo "$(GREEN)‚úÖ Nettoyage termin√©$(NC)"

check: ## V√©rifier la configuration
	@echo "$(BLUE)üîç V√©rification...$(NC)"
	@echo ""
	@echo "$(YELLOW)1. V√©rification de PJSUA2:$(NC)"
	@$(PJSIP_PY) -c "import pjsua2; print('   ‚úÖ PJSUA2 install√©')" 2>/dev/null || echo "   $(RED)‚ùå PJSUA2 non install√©$(NC)"
	@echo ""
	@echo "$(YELLOW)2. V√©rification de la configuration:$(NC)"
	@if [ -f test_config.env ]; then \
		echo "   ‚úÖ test_config.env existe"; \
		source test_config.env && \
		if [ -n "$$SIP_URI" ]; then echo "   ‚úÖ SIP_URI d√©fini"; else echo "   $(RED)‚ùå SIP_URI manquant$(NC)"; fi && \
		if [ -n "$$SIP_USERNAME" ]; then echo "   ‚úÖ SIP_USERNAME d√©fini"; else echo "   $(RED)‚ùå SIP_USERNAME manquant$(NC)"; fi && \
		if [ -n "$$SIP_PASSWORD" ]; then echo "   ‚úÖ SIP_PASSWORD d√©fini"; else echo "   $(RED)‚ùå SIP_PASSWORD manquant$(NC)"; fi; \
	else \
		echo "   $(RED)‚ùå test_config.env manquant$(NC)"; \
		echo "   Ex√©cutez: make -f Makefile.test config"; \
	fi
	@echo ""
	@echo "$(YELLOW)3. V√©rification d'OpenAI (pour bridge):$(NC)"
	@if [ -f test_config.env ]; then \
		source test_config.env && \
		if [ -n "$$OPENAI_API_KEY" ]; then echo "   ‚úÖ OPENAI_API_KEY d√©fini"; else echo "   $(YELLOW)‚ö†Ô∏è  OPENAI_API_KEY non d√©fini (requis pour test-bridge)$(NC)"; fi; \
	fi
	@echo ""

# Raccourcis
m: test-minimal ## Raccourci pour test-minimal
s: test-simple ## Raccourci pour test-simple
b: test-bridge ## Raccourci pour test-bridge
i: test-interactive ## Raccourci pour test-interactive
